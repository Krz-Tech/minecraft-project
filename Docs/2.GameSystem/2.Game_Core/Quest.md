ファイル：`Docs/2.GameSystem/2.Game_Core/Quest.md`
更新日時：`2026/01/02`

# クエストシステム

本ドキュメントでは、Delta Guildから提供されるクエストシステムの仕様を定義します。クエストはバックエンドのAIによって動的に生成され、プレイヤーのランクに応じて難易度・報酬がスケールします。

## 1. 概要

### 基本情報

| 項目 | 内容 |
|:---|:---|
| **提供元** | Delta Guild |
| **目的** | プレイグラウンド探索のガイド・報酬提供 |
| **生成方式** | バックエンドAI（LLM）による動的生成 |
| **特徴** | プレイヤーランクに応じた難易度・報酬のスケーリング |

### 設計思想

* クエストはプレイヤーに探索の方向性を提示する
* 報酬設計により特定の行動を促進
* AIによる動的生成でリプレイ性を確保
* ランクスケーリングにより成長感を演出

## 2. クエスト種別

### デイリークエスト

| 項目 | 内容 |
|:---|:---|
| **生成タイミング** | 毎日0:00（JST） |
| **生成数** | 3つ |
| **対象** | 全プレイヤー共通 |
| **リセット** | 毎日0:00 |
| **有効期限** | 当日23:59まで |

#### 特徴

* 全プレイヤーが同じクエストに挑戦
* コミュニティ内での話題共有が可能
* 日付ベースのシード値でAI生成を固定化

### ノーマルクエスト

| 項目 | 内容 |
|:---|:---|
| **生成タイミング** | 受注時 |
| **生成数** | 無限 |
| **対象** | 個人ごと |
| **同時受注数** | 最大5つ |
| **有効期限** | 受注から48時間 |

#### 特徴

* 受注するたびにAIが新規生成
* プレイヤーのランクに応じた難易度
* 期限切れは自動キャンセル（ペナルティなし）

## 3. クエストタイプ

### 討伐系

| 項目 | 内容 |
|:---|:---|
| **目標** | 指定モブを指定数討伐 |
| **例** | 「ゾンビを45体討伐せよ」 |
| **対象モブ** | ゾンビ、スケルトン、クリーパー、スパイダー等 |

### 収集系

| 項目 | 内容 |
|:---|:---|
| **目標** | 指定アイテムを指定数収集 |
| **例** | 「鉄鉱石を30個収集せよ」 |
| **対象アイテム** | 鉱石、素材、ドロップアイテム等 |

### 探索系

| 項目 | 内容 |
|:---|:---|
| **目標** | 指定バイオームに到達 |
| **例** | 「ジャングルバイオームに到達せよ」 |
| **対象バイオーム** | 救出バイオームと連動可能 |

### 複合型

| 項目 | 内容 |
|:---|:---|
| **目標** | 複数条件の組み合わせ |
| **例** | 「メサで金鉱石を15個採掘せよ」 |
| **組み合わせ** | バイオーム + 収集、バイオーム + 討伐 等 |

## 4. 難易度・報酬スケーリング

### ランクによる基準値

AIはプレイヤーのランクを入力として受け取り、以下の基準値を参考にクエストを生成する。

| ランク | 討伐目標 | 収集目標 | 報酬倍率 |
|:---:|:---|:---|:---:|
| 1 | 10〜20体 | 15〜30個 | x1.0 |
| 2 | 15〜30体 | 20〜40個 | x1.2 |
| 3 | 20〜40体 | 30〜50個 | x1.5 |
| 5 | 40〜60体 | 50〜80個 | x2.0 |
| 7 | 60〜90体 | 70〜110個 | x2.7 |
| 10 | 80〜120体 | 100〜150個 | x3.5 |

### 報酬構成

| 報酬種別 | 内容 |
|:---|:---|
| **Δコイン** | 基本報酬 × 報酬倍率 |
| **ランク経験値** | 基本報酬 × 報酬倍率 |
| **アイテム** | 確率でボーナスアイテム付与 |

## 5. 技術実装

### システム構成

```text
┌─────────────────┐     HTTP      ┌─────────────────┐
│   Minecraft     │ ───────────→  │   Quest API     │
│   Server        │               │   (FastAPI等)    │
│   (Skript+Reqn) │ ←─────────── │                 │
└─────────────────┘    JSON       └────────┬────────┘
                                           │
                                           ▼
                                  ┌─────────────────┐
                                  │     Ollama      │
                                  │   (Gemma等)     │
                                  └─────────────────┘
```

### 使用技術

| コンポーネント | 技術 | 用途 |
|:---|:---|:---|
| **Minecraft側** | Skript + Reqn | HTTPリクエスト送信 |
| **Minecraft側** | skript-json | JSONパース |
| **API側** | FastAPI等 | RESTful API |
| **LLM** | Ollama + Gemma | クエスト生成 |

### LLM選定方針

* Ollamaの統一APIにより、LLMの入れ替えが容易
* 試験を重ね、総合的に良いと判断したLLMを最終採用
* 候補: Gemma、Llama、Mistral等の軽量モデル

### API仕様

#### リクエスト

```json
{
  "player_uuid": "xxx-xxx-xxx",
  "player_rank": 5,
  "quest_type": "daily",
  "seed": 20260102
}
```

| フィールド | 型 | 説明 |
|:---|:---|:---|
| **player_uuid** | string | プレイヤーUUID |
| **player_rank** | int | プレイヤーのギルドランク |
| **quest_type** | string | `daily` または `normal` |
| **seed** | int | デイリー用シード（日付ベース） |

#### レスポンス

```json
{
  "quest_id": "quest_20260102_001",
  "type": "combat",
  "target": "zombie",
  "amount": 45,
  "biome": null,
  "rewards": {
    "delta_coin": 150,
    "rank_exp": 30,
    "items": [
      {"id": "iron_ingot", "amount": 5}
    ]
  },
  "description": "ゾンビを45体討伐せよ",
  "expires_at": "2026-01-04T12:00:00Z"
}
```

| フィールド | 型 | 説明 |
|:---|:---|:---|
| **quest_id** | string | クエスト一意識別子 |
| **type** | string | `combat`, `collect`, `explore`, `combined` |
| **target** | string | 対象モブ/アイテム |
| **amount** | int | 目標数 |
| **biome** | string/null | 対象バイオーム（探索系・複合型） |
| **rewards** | object | 報酬情報 |
| **description** | string | クエスト説明文 |
| **expires_at** | string | 有効期限（ISO 8601） |

### Skript実装例

```skript
# クエスト受注時
on quest accept:
    set {_rank} to guild rank of player
    set {_body} to json from "{""player_uuid"": ""%uuid of player%"", ""player_rank"": %{_rank}%, ""quest_type"": ""normal""}"

    async http post "http://localhost:8080/api/quest/generate" with body {_body}
    set {_response} to response body
    parse {_response} as json to {quest::%player%::*}

    send "&a新しいクエストを受注しました！" to player
    send "&7%{quest::%player%::description}%" to player
```

## 6. クエスト管理

### 受注フロー

1. プレイヤーがギルド本部でクエスト受注を選択
2. ノーマルクエストの場合、APIにリクエスト送信
3. AIがクエストを生成しレスポンス
4. クエスト情報をプレイヤーデータに保存
5. クエストUIに表示

### 完了判定

* プレイグラウンド内でのアクションを監視
* 討伐: モブキルイベント
* 収集: アイテム取得イベント
* 探索: バイオーム進入イベント
* 条件達成時に自動的に完了フラグを立てる

### 報酬受け取り

* プレイグラウンドから帰還後、ギルド本部で報酬を受け取り
* 帰還せずに死亡した場合、クエスト進捗はリセット
* 報酬はΔコイン、経験値、アイテムで構成

## 7. 未定義項目

以下の項目は今後の設計で詳細を決定する：

* クエストUIのデザイン
* LLMプロンプトの詳細設計
* 報酬の具体的な数値（基本報酬額）
* ボーナスアイテムの種類・確率
* クエスト受注時の演出

## 8. 参照ドキュメント

* [DeltaGuild.md](./DeltaGuild.md) - Delta Guild詳細
* [Playground.md](../2.Game_Battle/Playground.md) - プレイグラウンド仕様
* [Currency.md](../2.Game_Economy/Currency.md) - 通貨システム
