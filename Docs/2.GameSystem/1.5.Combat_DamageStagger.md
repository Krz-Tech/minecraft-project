# 戦闘システム：ダメージ・スタッガー計算 (Damage & Stagger)

## 概要
Tech::Playgroundの戦闘バランスの核となる「ダメージ計算」と「スタッガー（体勢崩し）」の仕様を定義します。

---

## 1. ダメージ計算 (Damage Calculation)

### 1.1 基本仕様
バニラのダメージイベントを拡張し、クリティカルやダイレクトヒット、スタッガー蓄積を統合しています。

| 項目 | 倍率 | 発動条件 |
|------|------|---------|
| **会心 (Critical)** | **1.5x** | ジャンプ中の攻撃（スプリント中を除く）。 |
| **直撃 (Direct Hit)** | **1.5x** | 対象がスタッガー（体勢崩し）状態の時の攻撃。 |
| **衝撃 (Impact)** | **0.5x (dmg)** | ダメージの 50% を衝撃値として蓄積。 |

### 1.2 演出
*   **ダメージ表示**: `display_show_damage` により対象の位置に数値がポップアップ。
*   **会心演出**: 特殊なSEと共に、黄色いクリティカル数値が表示。
*   **直撃演出**: `display_show_direct_hit` により、オレンジ色の強調された数値が表示。
*   **画面効果**: 被ダメージ時、`display_effect_damage_glitch` により視界が赤く歪むグリッチ演出が発生。

---

## 2. スタッガーシステム (Stagger System)

「衝撃（Impact）」を蓄積させ、敵のシステムを一時的にシャットダウンさせる挙動です。

### 2.1 仕様 (Internal Specs)
*   **スタッガー閾値 (Max)**: デフォルト **100** (Suit性能で変化)。
*   **自然減少 (Decay)**: **10 ticks ごとに 3** 減少（非攻撃状態時）。
*   **持続時間 (Duration)**: **2秒 (40 ticks)**。

### 2.2 スタッガー状態の効果
スタッガーがトリガーされると、以下の致命的なデバフが付与されます。
*   **移動停止**: `Slowness 255` によりその場に固定される。
*   **行動不能**: `Mining Fatigue 255`, `Weakness 255` により攻撃・採掘が制限される。
*   **視界悪化**: `Blindness` (0.5s) と `Slow Falling` による視界の揺れ。
*   **EN回復停止**: ACS再起動までEN管理が完全にストップする。

---

## 3. 技術メモ (Technical Implementation)

*   **変数管理**: 
    - `{-kp::%uuid%::stagger::current}` (現在の蓄積値)
    - `{-kp::%uuid%::stagger::active}` (スタッガー状態フラグ)
*   **実装モジュール**: `krz-combat/stagger.sk`, `krz-combat/damage-calculator.sk`
*   **回復完了時の演出**: タイトルに `Rebooting ACS...` と表示され、システム復旧音が再生される。

---

*最終更新: 2025-12-24*

