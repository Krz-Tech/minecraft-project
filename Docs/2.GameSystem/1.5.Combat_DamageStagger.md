# 戦闘システム：ダメージ・スタッガー計算 (Damage & Stagger)

## 概要
Tech::Playgroundの戦闘バランスの核となる「ダメージ計算」と「スタッガー（体勢崩し）」の仕様を定義します。

---

## 1. ダメージ計算式 (Damage Calculation)

本プロジェクトでは、バニラのダメージ計算を上書きし、Tech Suitの属性を反映した計算を行います。

### 1.1 基本式
```
最終ダメージ = (基礎攻撃力 * 武器倍率 * 部位補正) * (1 - 防御減算率) * 会心補正
```

| 項目 | 説明 | 影響源 |
|------|------|-------|
| **基礎攻撃力** | プレイヤーの素の攻撃力。 | ランク、戦闘スキル |
| **武器倍率** | 装備している武器固有の威力。 | ExecutableItems等 |
| **部位補正** | ヘッドショット(1.5x)等。 | 射撃精度、スマートエイム |
| **防御減算率** | SuitのDEF値による軽減。 `DEF / (DEF + 100)` 等の減衰曲線。 | Tech Suit |
| **会心補正** | 会心発生時、ダメージが1.5〜2.0倍に。 | アクセサリ、OSチップ |

---

## 2. スタッガーシステム (Stagger System)

「衝撃（Impact）」を蓄積させ、敵の体勢を崩すシステムです。AC（アーマード・コア）のスタッガーに近い挙動を目指します。

### 2.1 衝撃値の種類
1.  **衝撃力 (Impact)**: 攻撃時に即座に蓄積される値。
2.  **残留衝撃 (Accumulative Impact)**: 蓄積後、ゆっくりと自然減少する値。この合計が **スタッガー閾値** を超えるとスタッガー状態になる。

### 2.2 スタッガー状態の効果
*   **動作不能**: 1〜2秒間、アサルトダッシュや攻撃が不可になる（または極端に鈍化）。
*   **直撃ダメージ (Direct Hit)**: スタッガー中の敵に対するダメージが **1.2x 〜 1.5x** に上昇。
*   **EN回復停止**: スタッガー中はENのチャージが停止する。

### 2.3 衝撃耐性 (Stability)
*   Tech Suitの「安定性能」により、スタッガー閾値が変化する。
*   重量級スーツはスタッガーしにくいが、一度スタッガーすると復帰に時間がかかる。

---

## 3. 武器カテゴリ別の相性

| カテゴリ | ダメージ | 衝撃力 | 備考 |
|---------|---------|-------|------|
| **物理武器** | 中 | **高** | スタッガーを狙いやすい主兵装。 |
| **EN武器** | **高** | 低 | ダメージ源。衝撃は溜まりにくい。 |
| **バニラ強化** | 低 | 中 | 標準的な性能。コストが低い。 |
| **パイルバンカー**| **特大** | **特大** | 当てれば即スタッガーに近い性能。 |

---

## 4. UI・演出 (Feedback)

### 4.1 プライベートHUD表示
*   **スタッガーゲージ**: ターゲットの頭上に、パケットベースのHUDで蓄積度を表示。
*   **フルゲージ**: 赤く点滅し、`!! STAGGER !!` の警告を表示。

### 4.2 エフェクト
*   **衝撃波**: 蓄積量が多い攻撃を受けた際、プレイヤーの画面がわずかに揺れる。
*   **スタッガー時**: 電磁火花（パーティクル）が散り、システムダウン音を再生。

---

## 5. 技術メモ (Technical Implementation)

*   **変数管理**: 
    - `{-kp::%uuid%::stat::stagger}` (現在の蓄積値)
    - `{-kp::%uuid%::stat::stability}` (スタッガー閾値)
*   **減少ロジック**: `every 5 ticks` 等で、非攻撃状態が一定時間続いたら `stagger` 変数を徐々に減算。
*   **ダメージフック**: `on damage` イベントを `priority: highest` でキャンセルし、自前の計算後に `damage target by {_dmg} amount` を実行。

---

*最終更新: 2025-12-23*
