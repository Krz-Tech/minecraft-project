ファイル：`Docs/1.Development/1.Dev_McScript.md`
更新日時：`2026/01/03`

# mcスクリプト仕様

Coder環境でMinecraft開発サーバーを管理するためのシェルスクリプト`mc`の仕様を定義します。人間とAIエージェントの両方が使用することを前提に設計されています。

## 1. 概要

`mc`スクリプトは、Coder環境内でMinecraft開発サーバーのライフサイクル管理を行うBashスクリプトです。

* **配置場所**: `minecraft-project-workspace/mc`
* **実行方法**: `./mc <command> [args]`
* **対象**: PaperMC 1.21.4 開発サーバー

## 2. 前提条件

### 必須パッケージ

| パッケージ | 用途 |
|:---|:---|
| `git` | ドキュメントリポジトリのクローン |
| `screen` | サーバープロセスのバックグラウンド実行 |
| `java` (21以上) | Minecraftサーバー実行 |

### ディレクトリ構成

```text
minecraft-project-workspace/
├── mc                    # 本スクリプト
├── docs/                 # ドキュメント (minecraft-projectのクローン)
├── server/               # Minecraftサーバーディレクトリ
│   ├── paper.jar         # PaperMCサーバーJAR
│   ├── server.properties # サーバー設定
│   ├── plugins/          # プラグインディレクトリ
│   └── logs/             # ログディレクトリ
└── scripts/              # 補助スクリプト（必要に応じて）
```

## 3. コマンド一覧

### setup

初回セットアップを実行します。

```bash
./mc setup
```

* ドキュメントリポジトリ（`minecraft-project`）のクローン
* PaperMC 1.21.4 build 232のダウンロード
* `eula.txt`の自動同意
* 初期`server.properties`の生成
* 必須ディレクトリ（plugins, logs）の作成

> 既に`docs/`が存在する場合は`git pull`で更新を試みます。

**終了コード**:
* `0`: 成功
* `1`: エラー（詳細は標準エラー出力）

### start

開発サーバーを起動し、ポートフォワードを開始します。

```bash
./mc start
```

* `screen`セッション名: `minecraft`
* ポートフォワード: `25565`
* 既に起動中の場合はエラー

**終了コード**:
* `0`: 起動成功
* `1`: 既に起動中 or エラー

### stop

開発サーバーを停止し、ポートフォワードを終了します。

```bash
./mc stop
```

* `stop`コマンドをサーバーに送信後、プロセス終了を待機
* タイムアウト: 30秒（超過時は強制終了）

**終了コード**:
* `0`: 停止成功
* `1`: サーバーが起動していない or エラー

### attach

サーバーコンソール（screenセッション）にアタッチします。

```bash
./mc attach
```

* **人間専用**: 対話操作が必要なため、エージェントは使用不可
* デタッチ: `Ctrl+A` → `D`

> **注意**: エージェントはこのコマンドを使用せず、`send`コマンドを使用してください。

### send

Minecraftサーバーにコマンドを送信します。

```bash
./mc send <command>
```

* **エージェント向け**: 非対話でコマンド実行が可能
* `screen -S minecraft -X stuff`経由で送信

**使用例**:

```bash
# Skriptのリロード
./mc send "sk reload scripts/test.sk"

# プレイヤーリスト取得
./mc send "list"

# ゲームルール変更
./mc send "gamerule doDaylightCycle false"
```

**終了コード**:
* `0`: 送信成功
* `1`: サーバーが起動していない or 引数エラー

### status

サーバーの状態を確認します。

```bash
./mc status
```

**出力形式**:

```text
running
```
または
```text
stopped
```

**終了コード**:
* `0`: 起動中
* `1`: 停止中

**エージェント向け使用例**:

```bash
if ./mc status > /dev/null 2>&1; then
    echo "サーバーは起動中です"
else
    echo "サーバーは停止中です"
fi
```

## 4. エージェント向けガイドライン

AIエージェントがこのスクリプトを使用する際のガイドラインです。

### ドキュメント参照

`docs/`ディレクトリには`minecraft-project`リポジトリがクローンされています。実装時はこのドキュメントを参照してください。

```bash
# ドキュメントの確認
ls docs/Docs/

# 特定のドキュメントを読む
cat docs/Docs/1.Development/1.Dev_Skript.md
```

### 推奨ワークフロー

1. `./mc status`でサーバー状態を確認
2. 停止中であれば`./mc start`で起動
3. `./mc send`でコマンドを実行
4. 作業完了後、必要に応じて`./mc stop`で停止

### コマンド実行後のログ確認

`./mc send`はコマンド送信のみを行い、結果は返しません。実行結果を確認する必要がある場合は、ログファイルを参照してください。

```bash
# 最新ログの確認
tail -n 50 server/logs/latest.log
```

### Skript開発での使用

```bash
# Skriptファイル編集後のリロード
./mc send "sk reload <ファイル名>"

# 構文エラーの確認はログで行う
tail -n 20 server/logs/latest.log | grep -i "error\|warning"
```

### 禁止事項

* `./mc attach`の使用（対話セッションはエージェントに不適）
* サーバー起動確認なしでの`send`コマンド実行
* 短時間での連続コマンド送信（最低1秒間隔を推奨）

## 5. 実装時の注意事項

`minecraft-project-workspace`リポジトリで実装する際の注意点です。

### screenセッション管理

* セッション名は固定で`minecraft`を使用
* 複数サーバーの同時起動は非対応

### エラーハンドリング

* 全コマンドで適切な終了コードを返すこと
* エラーメッセージは標準エラー出力に出力
* 成功メッセージは標準出力に出力

### ログ出力

* スクリプト自体のログは`logs/mc.log`に記録（オプション）
* タイムスタンプ形式: `YYYY-MM-DD HH:MM:SS`

### 移植性

* POSIX準拠のBashスクリプトとして実装
* 外部依存は最小限に抑える
