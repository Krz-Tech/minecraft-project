ファイル：`Docs/0.System/0.Sys_Deployment.md`
更新日時：`2025/12/31`

# 本番環境デプロイメント定義

本ドキュメントでは、Minecraftプロジェクトの本番環境（Production Environment）におけるインフラストラクチャ構成、デプロイメント戦略、および関連する周辺エコシステムについて定義します。

## 1. インフラストラクチャ概要

本番環境はオンプレミス（Home Lab）のKubernetesクラスター上に構築され、Cloudflareのエッジネットワークを通じて外部に公開されます。

### 技術スタック
| カテゴリ | 技術・ツール | 用途・備考 |
|:---|:---|:---|
| **Compute** | **Kubernetes** | コンテナ・オーケストレーション |
| **GitOps** | **ArgoCD** | マニフェストの自動同期 (Pull型) |
| **Tunneling** | **Cloudflare Tunnel** | 安全なインバウンド接続 (No Port Forwarding) |
| **Network** | **MetalLB** | クラスタ内部から外部へのアクセスのために使用 |
| **GameServer** | **Paper 1.21.4** | Minecraftサーバー |
| **Proxy** | **Velocity** | Minecraftプロキシサーバー|
| **Storage** | **Kubernetes PVC** | サーバーの永続ボリューム |
| **Object Storage** | **Cloudflare R2** | バックアップ、リソースパック配信 |

### ネットワークフロー (Ingress)
プレイヤーがサーバーに接続するまでのトラフィックフローは以下の通りです。

```mermaid
graph LR
    User([Player]) -->|TCP| VPS["VPS (Ingress Node)"]
    VPS -->|Cloudflare Tunnel| HL["Home Lab"]
    HL -->|Tunnel Connector| K8s["K8s Cluster"]
    subgraph Kubernetes Cluster
        K8s -->|MetalLB| V["Velocity Proxy"]
        V -->|TCP| P["PaperMC Server"]
    end
```

1.  **VPS**: パブリックIPを持つエントリーポイント。Cloudflare Tunnelのエッジとして機能します。
2.  **Cloudflare Tunnel**: VPSとHome Lab間を暗号化されたトンネルで接続します。ファイアウォールのポート開放は不要です。
3.  **MetalLB**: クラスタ内でVelocity PodにLoadBalancer IP (VIP) を割り当てます。
4.  **Velocity**: バックエンドのPaperMCサーバーへ接続をルーティングします。

## 2. リソース構成

### コンピュートリソース (Pods)
*   **Minecraft Server**: Paper 1.21.4を使用します。カスタムした独自のDockerイメージでPODを作成します。
*   **Velocity Proxy**: 最新バージョンのVelocityを使用します。ユーザーのサーバールーティングに使用するプロキシサーバーです。カスタムした独自のDockerイメージでPODを作成します。

### ストレージ戦略
データの永続化とバックアップには、用途に応じて異なるストレージクラスを使用します。

| データ種別 | ストレージ | 詳細 |
|:---|:---|:---|
| **World Data** | **PVC** | 低レイテンシ・高可用性が求められるメインデータ。 |
| **User Data** | **PVC** | プレイヤーデータ、統計情報など。 |
| **Backup** | **Cloudflare R2** | 定期バックアップの送付先。容量単価と可用性を重視。 |
| **Logs** | **Cloudflare R2** | 過去ログのアーカイブ。 |
| **Assets** | **Cloudflare R2** | リソースパック等の静的ファイル配信。 |

## 3. Cloudflareサービス
本プロジェクトではCloudflare Tunnel, Cloudflare Workersやその他サービスを活用し、以下のようなシステムを構築します。
### A. 拠点間VPN
インターネット外部に露出しているVPSと自宅サーバー間でCloudflare Tunnelを使用したVPNを構築しています。自宅サーバーから直接露出させず、Cloudflareを経由することで自宅サーバーを安全に運用しています。

### B. リソースパック配信
常に最新のリソースパックを高速かつ低コストに配信するシステムです。

*   **ドメイン**: `rp.mc.krz-tech.net`
*   **構成**:
    *   **Registry**: 管理者はR2へリソースパックをアップロード。
    *   **Computation**: Workerがアップロード時にSHA-1ハッシュを自動計算し、Workers KVに `verify-hash` を保存。
    *   **Endpoint**: サーバープラグインは `/api/pack/latest` を叩くことで、計算済みのハッシュとダウンロードURLを取得可能。
    *   **Delivery**: プレイヤーへのzipファイル配信は、WorkerがR2からストリーミングし、エッジキャッシュを効かせて高速化。

### C. サーバー死活監視・MOTDリモート更新バックエンド
Webサイト、Minecraftのプロキシサーバーから使用する汎用バックエンドサーバー

*   **ドメイン**: `motd.mc.krz-tech.net`
*   **構成**:
    *   **Cron Trigger**: Workeres Cronが1分ごとにVelocityへPingを送信。
    *   **Caching**: 取得したステータス（人数、MOTD、Ping応答時間）をKVにキャッシュ。
    *   **Remote Config**: メンテナンスモードのON/OFFやカスタムMOTDをKV経由で注入可能。
    *   **Benefit**: KV経由でデータを取得するため、Webサイトへのアクセスによる負荷を軽減できる。

## 4. リポジトリ構成と役割

| リポジトリ名 | 役割 | 監視ツール |
|:---|:---|:---|
| `minecraft-project-infra` | K8sマニフェスト、Helmチャート、ArgoCD設定 | ArgoCD |
| `minecraft-project-skript` | ゲームロジック (Skript)、プラグイン設定 | ArgoCD (Sidecar Sync) |

デプロイメント（本番反映）はArgoCDによるGitレポジトリの定期ポーリングによって行われます。
開発フローの詳細は [Docs/0.System/0.Sys_Flow.md](Docs/0.System/0.Sys_Flow.md) を参照してください。
