# Skript パフォーマンス負荷シミュレーション (Performance Analysis)

## 1. 概要
本プロジェクトの全機能を Skript (+ アドオン) で実装した場合の負荷を、プレイヤー数 50名を想定してシミュレーションします。

---

## 2. システム別・負荷予測

### 2.1 サーバー間データ同期 (SQL Push/Pull)
*   **負荷タイプ**: I/O 待機、ネットワークレイテンシ
*   **発生タイミング**: Join/Quit/サーバー転送時
*   **シミュレーション結果**:
    *   **バニラ方式 (同期要求)**: 保存・読込中にメインスレッドが止まり、TPSが瞬間的に 5〜10 程度低下する。
    *   **本プロジェクト方式 (非同期要求)**: `skript-reflect` 等で非同期処理を行うため、TPSへの影響はほぼなし。ただし、読込完了までの「待機時間（2秒程度）」が発生する。

### 2.2 戦闘システム (Smart Aim / Tick処理)
*   **負荷タイプ**: CPU (演算)
*   **発生頻度**: `every 1 to 5 ticks`
*   **懸念点**: 全プレイヤーの視線先にあるエンティティを常に計算する。
*   **シミュレーション結果**:
    *   50名が同時に戦闘した場合、バニラの `target entity` を多用すると CPU Load が 30% 以上増加するリスクあり。
    *   **最適化策**: 距離（10m以内等）でフィルタリングし、計算頻度を 3~5 ticks に落とすことで、TPS 19.5 以上を維持可能。

### 2.3 ログイン演出 (ブートシーケンス)
*   **負荷タイプ**: パケット通信、演出処理
*   **発生頻度**: プレイヤー参加時のみ
*   **シミュレーション結果**:
    *   タイトル表示やパーティクル生成は負荷が極めて低く、無視できるレベル。

### 2.4 変数ストレージ (Variables)
*   **負荷タイプ**: メモリ (RAM)
*   **シミュレーション結果**:
    *   Skript の変数ストレージ (`variables.csv` / `variables.db`) は数千件程度なら数十MB程度。
    *   ただし、全ての履歴などを変数に詰め込むと、定期的なDB保存時にラグが発生する。
    *   **最適化策**: 永続データは SQL へ逃がし、Skript 変数は「現在のセッションデータ」のみに限定する。

---

## 3. 推定TPS影響 (50人同時接続時)

| システム状態 | 推定TPS | 負荷の主な原因 |
|-------------|---------|---------------|
| 待機時 (ロビー) | 20.0 | 基本負荷のみ |
| 通常戦闘 (PG) | 18.5 - 19.5 | エンティティ追跡、ダメージ計算 |
| 大規模戦闘 / 転送ラッシュ | 15.0 - 18.0 | SQL I/O 集中、全プレイヤーへのブロードキャスト |

---

## 4. 限界点と対策 (Scalability)

### 限界点: メインスレッドの壁
Skript は基本的に Java のメインスレッドで動作します。複雑すぎるループやバニラコマンドの実行 (`make player execute command`) は TPS 悪化に直結します。

### 対策 (Optimization Rules)
1.  **非同期 SQL**: `skript-reflect` を使い、DB操作を別スレッドで実行する。
2.  **計算の削減**: `on move` の使用を禁止。代わりに `every 2 ticks` 等で位置チェックを行う。
3.  **NBTの最小化**: アイテムのNBTを毎回パースせず、可能な限り ID やメタデータで判定する。
4.  **プロキシの活用**: チャットやパーティなどの「軽い」データは Velocity 側で処理し、Paper 鯖への負荷を減らす。

---

## 5. 結論
Skript で全実装を行っても、**適切な非同期処理と計算の最適化を行えば、50名規模のサーバー運営は十分に可能** です。

特に **「毎 tick の全プレイヤー検索」** のような重い処理を避け、イベント駆動（Event-driven）な設計を徹底することで、高いパフォーマンスを維持できます。

---

*最終更新: 2025-12-23*
